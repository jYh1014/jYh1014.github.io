<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>vue | jyy</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="vue" /><meta name="author" content="jyy" /><meta property="og:locale" content="en_US" /><meta name="description" content="vue是一个什么样的框架 它借鉴了MVVM框架，但是和他并不完全一样。相同之处都是数据变化视图会更新，视图变化数据会被影响（响应式数据原理）。不同之处是MVVM不能跳过数据去直接更新视图，而vue可以通过操作dom来更新视图" /><meta property="og:description" content="vue是一个什么样的框架 它借鉴了MVVM框架，但是和他并不完全一样。相同之处都是数据变化视图会更新，视图变化数据会被影响（响应式数据原理）。不同之处是MVVM不能跳过数据去直接更新视图，而vue可以通过操作dom来更新视图" /><link rel="canonical" href="http://localhost:4000/posts/vue/" /><meta property="og:url" content="http://localhost:4000/posts/vue/" /><meta property="og:site_name" content="jyy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-16T11:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="vue" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@jyy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"datePublished":"2020-09-16T11:00:00+08:00","dateModified":"2020-09-16T11:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/vue/"},"url":"http://localhost:4000/posts/vue/","author":{"@type":"Person","name":"jyy"},"description":"vue是一个什么样的框架 它借鉴了MVVM框架，但是和他并不完全一样。相同之处都是数据变化视图会更新，视图变化数据会被影响（响应式数据原理）。不同之处是MVVM不能跳过数据去直接更新视图，而vue可以通过操作dom来更新视图","@type":"BlogPosting","headline":"vue","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">jyy</a></div><div class="site-subtitle font-italic"></div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/github_username" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['example','doamin.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>vue</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>vue</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 16, 2020, 11:00 AM +0800" > Sep 16, 2020 <i class="unloaded">2020-09-16T11:00:00+08:00</i> </span> by <span class="author"> jyy </span></div></div><div class="post-content"><h2 id="vue是一个什么样的框架">vue是一个什么样的框架</h2><blockquote><p>它借鉴了MVVM框架，但是和他并不完全一样。相同之处都是数据变化视图会更新，视图变化数据会被影响（响应式数据原理）。不同之处是MVVM不能跳过数据去直接更新视图，而vue可以通过操作dom来更新视图</p></blockquote><blockquote><p>MVVM模型的组成部分</p><ul><li>model（模型）：模型是指代表真实状态内容的领域模型（面向对象），或指代表内容的数据访问层（以数据为中心）。<li>view（视图）：视图是用户在屏幕上看到的结构、布局和外观（UI）<li>viewModel（视图模型）：<li>binder（绑定器）</ul></blockquote><blockquote><p>也就是给我什么样的数据，我就渲染出什么样的页面。如下面的html为例，在我修改data数据时，都能渲染出相应的页面。</p></blockquote><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span> <span class="na">style=</span><span class="s">"color: red"</span><span class="nt">&gt;</span>
        
        {{arr}}
        
        <span class="nt">&lt;li&gt;</span> {{school.name}}<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>{{school.age}}<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./dist/umd/vue.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jyy</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">arr</span><span class="p">:</span> <span class="p">[{</span> <span class="na">a</span><span class="p">:</span> <span class="mi">10</span> <span class="p">},</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="na">school</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jyy</span><span class="dl">"</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
            <span class="na">el</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#app</span><span class="dl">"</span><span class="p">,</span>
            <span class="c1">// data: [1,2,3]</span>
            <span class="na">data</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
            <span class="nx">created</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">my created-----</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>
      
        <span class="nx">vm</span><span class="p">.</span><span class="nx">_data</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">aaaa</span><span class="dl">"</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">_data</span><span class="p">)</span>
      
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></table></code></div></div><blockquote><p>想要实现这个效果，必须先知道vue整个的渲染流程：先初始化数据 =》将模版进行编译 =》 生成render函数 =》 生成虚拟节点 =》生成真实的dom =》放到页面上</p></blockquote><h2 id="1初始化数据对数据的劫持">1.初始化数据（对数据的劫持）</h2><blockquote><p>当我们访问或设置数据的属性的时候，都会触发相对应的函数。也就是说修改数据时，要知道数据是不是做了修改，然后再更新视图。这个就是劫持操作。</p></blockquote><blockquote><p>主要是依赖Object.defineProperty来实现的。</p></blockquote><blockquote><p>下面看一个完整的vue初始化代码</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">Vue</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_init</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">initMixin</span><span class="p">(</span><span class="nx">Vue</span><span class="p">)</span> <span class="c1">//用插件的方式来扩展方法。</span>

<span class="kd">function</span> <span class="nx">initMixin</span><span class="p">(</span><span class="nx">Vue</span><span class="p">){</span>
    <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">this</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span> <span class="o">=</span> <span class="nx">options</span>
        <span class="nx">initState</span><span class="p">(</span><span class="nx">vm</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">initState</span><span class="p">(</span><span class="nx">vm</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">initData</span><span class="p">(</span><span class="nx">vm</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initData</span><span class="p">(</span><span class="nx">vm</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">data</span>
    <span class="nx">vm</span><span class="p">.</span><span class="nx">_data</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">?</span><span class="nx">data</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">vm</span><span class="p">):</span><span class="nx">data</span>
    <span class="nx">observe</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">observe</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span><span class="p">){</span>
        <span class="k">return</span><span class="p">;</span> <span class="c1">//只对对象和数组做监测</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">observeArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="c1">//观测数组中的对象类型</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">walk</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">walk</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">defineReactive</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
    <span class="p">})</span>
<span class="p">}</span>
 <span class="kd">function</span> <span class="nx">observeArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">observe</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">defineReactive</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">observe</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="c1">//递归</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
        <span class="kd">get</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`读取了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">value</span>
        <span class="p">},</span>
        <span class="kd">set</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`设置了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">newValue</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="k">return</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="c1">//此时在html中加上vm._data.name = "aaa"就会触发set函数执行，也就是说得到了劫持。</span>
<span class="c1">//但是 vm._data.name={a:10}并不会触发set，我们需要修改一下defineReactive方法的代码。</span>
<span class="kd">function</span> <span class="nx">defineReactive</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">observe</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
        <span class="kd">get</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`读取了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">value</span>
        <span class="p">},</span>
        <span class="kd">set</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`设置了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">newValue</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="k">return</span>
            <span class="nx">observe</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="c1">//需要对重新赋值的数据也做监测</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="c1">//到此为止，对对象类型的劫持已经完成，但是对数组类型的劫持还有欠缺，在vue中，只对数组的这些方法做了监测，push、pop、shift</span>
<span class="c1">//、unshift、reverse、sort、splice，这些方法都能修改原始数组。所以，在数组调用这些方法的时候，我们也要做到劫持。我们需要对数组的原始方法做一些扩展。</span>
<span class="kd">let</span> <span class="nx">oldArrayMethods</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span>
<span class="kd">let</span> <span class="nx">arrayMethods</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">oldArrayMethods</span><span class="p">);</span> <span class="c1">//继承 arrayMethods.__proto__ == oldArrayMethods</span>
<span class="kd">let</span> <span class="nx">methods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="dl">"</span><span class="s2">push</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">pop</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">shift</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">unshift</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sort</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">reverse</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">splice</span><span class="dl">"</span>
<span class="p">]</span>
<span class="nx">methods</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">method</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">arrayMethods</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(...</span><span class="nx">args</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">数组方法拦截</span><span class="dl">"</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">oldArrayMethods</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="dl">"</span><span class="s2">push</span><span class="dl">"</span><span class="p">:</span> <span class="c1">//追加</span>
            <span class="k">case</span> <span class="dl">"</span><span class="s2">unshift</span><span class="dl">"</span><span class="p">:</span>
                <span class="nx">inserted</span> <span class="o">=</span> <span class="nx">args</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="dl">"</span><span class="s2">splice</span><span class="dl">"</span><span class="p">:</span>
                <span class="nx">inserted</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="nl">default</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//对数组新增的值也要进行监测，需要调用observeArray方法</span>
        <span class="nx">observeArray</span><span class="p">(</span><span class="nx">inserted</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">result</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1">//vue2对数组监测的弊端在官网上也有说明，以下两种目前还不能做到劫持</span>
<span class="c1">//1.当你利用索引直接设置一个数组项时</span>
<span class="c1">//2.当你修改数组的长度时</span>
</pre></table></code></div></div><h2 id="2将模版编译成render函数">2.将模版编译成render函数</h2><ul><li>第一步：生成ast树<li>第二步：优化（静态节点可以跳过）<li>第三步：将优化后的AST树转换为可执行的代码</ul><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>//比如这段html
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"app"</span> <span class="na">style=</span><span class="s">{color:</span> <span class="err">"</span><span class="na">red</span><span class="err">"}</span><span class="nt">&gt;</span>hello<span class="nt">&lt;span&gt;</span>hello<span class="nt">&lt;/span</span><span class="err">&lt;/div</span><span class="nt">&gt;</span>
//我们需要将其编译成

</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">_c</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">,{</span><span class="na">id</span><span class="p">:</span><span class="dl">'</span><span class="s1">app</span><span class="dl">'</span><span class="p">,</span><span class="na">style</span><span class="p">:{</span><span class="na">color</span><span class="p">:</span><span class="dl">'</span><span class="s1">red</span><span class="dl">'</span><span class="p">}},</span><span class="nx">_v</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="o">+</span><span class="nx">_s</span><span class="p">(</span><span class="nx">name</span><span class="p">)),</span><span class="nx">_c</span><span class="p">(</span><span class="dl">'</span><span class="s1">span</span><span class="dl">'</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">_v</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">)))</span><span class="err">。</span>
<span class="nx">最终得到的render函数大概就是以下这种形式</span>
<span class="kd">function</span> <span class="nx">anonymous</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">with</span><span class="p">(</span><span class="k">this</span><span class="p">){</span><span class="k">return</span> <span class="nx">_c</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">,{</span><span class="na">id</span><span class="p">:</span><span class="dl">'</span><span class="s1">app</span><span class="dl">'</span><span class="p">,</span><span class="na">style</span><span class="p">:{</span><span class="na">color</span><span class="p">:</span><span class="dl">'</span><span class="s1">red</span><span class="dl">'</span><span class="p">}},</span><span class="nx">_v</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="o">+</span><span class="nx">_s</span><span class="p">(</span><span class="nx">name</span><span class="p">)),</span><span class="nx">_c</span><span class="p">(</span><span class="dl">'</span><span class="s1">span</span><span class="dl">'</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="nx">_v</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">)))}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>其中涉及两个过程，1:需要将html代码转换成ast语法树 2:通过这棵树重新生成虚拟节点</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
</pre><td class="rouge-code"><pre><span class="c1">//将_init方法修改一下</span>
 <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_init</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">this</span>
    <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="o">=</span><span class="nx">options</span>
    <span class="nx">initState</span><span class="p">(</span><span class="nx">vm</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">$mount</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
 <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$mount</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">this</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span>
    <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>
    <span class="nx">vm</span><span class="p">.</span><span class="nx">$el</span> <span class="o">=</span> <span class="nx">el</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">template</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">template</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">template</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">outerHTML</span>
        <span class="p">}</span>
        <span class="c1">//将模版编译成render函数</span>
        <span class="kd">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="nx">compilerToFunctions</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">render</span>
    <span class="p">}</span>
    <span class="c1">//然后挂载这个组件</span>
    <span class="c1">//todo。。。</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">compilerToFunctions</span><span class="p">(){</span>
    <span class="kd">let</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">parseHTML</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="c1">//将html代码转换成ast语法树</span>
    <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="c1">//通过这棵树重新生成虚拟节点</span>
    <span class="kd">let</span> <span class="nx">render</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s2">`with(this){return </span><span class="p">${</span><span class="nx">code</span><span class="p">}</span><span class="s2">}`</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">render</span>
<span class="p">}</span>

<span class="c1">//以下是根据正则匹配标签的过程。</span>
<span class="kd">const</span> <span class="nx">ncname</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">[a-zA-Z_][</span><span class="se">\\</span><span class="s2">-</span><span class="se">\\</span><span class="s2">.0-9a-zA-Z]*</span><span class="dl">"</span>  <span class="c1">//标签名</span>
<span class="kd">const</span> <span class="nx">qnameCapture</span> <span class="o">=</span> <span class="s2">`((?:</span><span class="p">${</span><span class="nx">ncname</span><span class="p">}</span><span class="s2">\\:)?</span><span class="p">${</span><span class="nx">ncname</span><span class="p">}</span><span class="s2">)`</span>  <span class="c1">//&lt;my:xx&gt;</span>
<span class="kd">const</span> <span class="nx">startTagOpen</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">`^&lt;</span><span class="p">${</span><span class="nx">qnameCapture</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">endTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">`^&lt;\\/</span><span class="p">${</span><span class="nx">qnameCapture</span><span class="p">}</span><span class="s2">[^&gt;]*&gt;`</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">\s</span><span class="sr">*</span><span class="se">([^\s</span><span class="sr">"'&lt;&gt;</span><span class="se">\/</span><span class="sr">=</span><span class="se">]</span><span class="sr">+</span><span class="se">)(?:\s</span><span class="sr">*</span><span class="se">(</span><span class="sr">=</span><span class="se">)\s</span><span class="sr">*</span><span class="se">(?:</span><span class="sr">"</span><span class="se">([^</span><span class="sr">"</span><span class="se">]</span><span class="sr">*</span><span class="se">)</span><span class="sr">"+|'</span><span class="se">([^</span><span class="sr">'</span><span class="se">]</span><span class="sr">*</span><span class="se">)</span><span class="sr">'+|</span><span class="se">([^\s</span><span class="sr">"'=&lt;&gt;`</span><span class="se">]</span><span class="sr">+</span><span class="se">)))?</span><span class="sr">/</span>
<span class="kd">const</span> <span class="nx">startTagClose</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">\s</span><span class="sr">*</span><span class="se">(\/?)</span><span class="sr">&gt;/</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">defaultTagRE</span> <span class="o">=</span> <span class="sr">/</span><span class="se">\{\{((?:</span><span class="sr">.|</span><span class="se">\r?\n)</span><span class="sr">+</span><span class="se">?)\}\}</span><span class="sr">/g</span>
<span class="kd">function</span> <span class="nx">parseHTML</span><span class="p">(</span><span class="nx">html</span><span class="p">){</span>
        <span class="kd">function</span> <span class="nx">createASTElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">tag</span><span class="p">:</span> <span class="nx">tagName</span><span class="p">,</span>
            <span class="nx">attrs</span><span class="p">,</span>
            <span class="na">parent</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="na">children</span><span class="p">:</span> <span class="p">[],</span>
            <span class="na">type</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">root</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">currentParent</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">createASTElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span><span class="nx">attrs</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">root</span><span class="p">){</span>
            <span class="nx">root</span> <span class="o">=</span> <span class="nx">element</span>
        <span class="p">}</span>
        <span class="nx">currentParent</span> <span class="o">=</span> <span class="nx">element</span>
        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">end</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span> 
        <span class="kd">let</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="nx">currentParent</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">currentParent</span><span class="p">){</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">currentParent</span>
            <span class="nx">currentParent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">chars</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">/g</span><span class="p">,</span><span class="dl">""</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">text</span><span class="p">){</span>
            <span class="nx">currentParent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                <span class="na">type</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                <span class="nx">text</span>
            <span class="p">})</span>
        <span class="p">}</span>
     <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">textEnd</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">textEnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//肯定是标签</span>
            <span class="kd">const</span> <span class="nx">startTagMatch</span> <span class="o">=</span> <span class="nx">parseStartTag</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">startTagMatch</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">start</span><span class="p">(</span><span class="nx">startTagMatch</span><span class="p">.</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">startTagMatch</span><span class="p">.</span><span class="nx">attrs</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// console.log(html)</span>
            <span class="kd">const</span> <span class="nx">endTagMatch</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">endTag</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">endTagMatch</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">advance</span><span class="p">(</span><span class="nx">endTagMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">end</span><span class="p">(</span><span class="nx">endTagMatch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nx">text</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">textEnd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">textEnd</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">advance</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">chars</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// break;</span>
        
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">advance</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">parseStartTag</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">startTagOpen</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">tagName</span><span class="p">:</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="na">attrs</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
            <span class="nx">advance</span><span class="p">(</span><span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
            <span class="c1">//如果直接是闭合标签，那说明没有属性</span>
            <span class="kd">let</span> <span class="nx">end</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">attr</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">startTagClose</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">attr</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)))</span> <span class="p">{</span>

                <span class="nx">match</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="na">value</span><span class="p">:</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">})</span>
                <span class="nx">advance</span><span class="p">(</span><span class="nx">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
                <span class="c1">// break;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">advance</span><span class="p">(</span><span class="nx">end</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">match</span>
            <span class="p">}</span>
            <span class="c1">// console.log(html)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">root</span>
<span class="p">}</span>

<span class="c1">//以下是根据ast来生成render函数</span>
<span class="c1">//&lt;div id="app" style={color: "red"}&gt;hello&lt;span&gt;hello&lt;/span&lt;/div&gt;</span>
<span class="c1">//_c('div',{id:'app',style:{color:'red'}},_v('hello'+_s(name)),_c('span',null,_v('hello')))</span>
<span class="kd">const</span> <span class="nx">defaultTagRE</span> <span class="o">=</span> <span class="sr">/</span><span class="se">\{\{((?:</span><span class="sr">.|</span><span class="se">\r?\n)</span><span class="sr">+</span><span class="se">?)\}\}</span><span class="sr">/g</span>
<span class="kd">function</span> <span class="nx">genProps</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">''</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">;</span><span class="dl">"</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
            <span class="p">})</span>
            <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span>
        <span class="p">}</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span><span class="s2">,`</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s2">`{</span><span class="p">${</span><span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)}</span><span class="s2">}`</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">gen</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">text</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">defaultTagRE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">`_v(</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">)}</span><span class="s2">)`</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="kd">let</span> <span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">defaultTagRE</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">index</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">defaultTagRE</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">index</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="nx">lastIndex</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">index</span><span class="p">)))</span>
            <span class="p">}</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">`_s(</span><span class="p">${</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">()}</span><span class="s2">)`</span><span class="p">)</span>
            <span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lastIndex</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">lastIndex</span><span class="p">)))</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s2">`_v(</span><span class="p">${</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="s2">+</span><span class="dl">"</span><span class="p">)}</span><span class="s2">)`</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">genChildren</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">children</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span> <span class="o">=&gt;</span> <span class="nx">gen</span><span class="p">(</span><span class="nx">child</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="s2">,</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">genChildren</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">`_c('</span><span class="p">${</span><span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">}</span><span class="s2">',</span><span class="p">${</span><span class="nx">el</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span> <span class="p">?</span> <span class="s2">`</span><span class="p">${</span><span class="nx">genProps</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">attrs</span><span class="p">)}</span><span class="s2">`</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">}${</span><span class="nx">children</span> <span class="p">?</span> <span class="s2">`,</span><span class="p">${</span><span class="nx">children</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="dl">""</span>
        <span class="p">}</span><span class="s2">)`</span>
    <span class="k">return</span> <span class="nx">code</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="3依赖收集">3.依赖收集</h2><ul><li>利用Obeject.defineProperty()来监听属性变动，将需要observe的数据对象进行递归遍历，包括子属性对象的属性，都加上 setter和getter<li>当给这个对象的某个值赋值，就会触发setter，进而监听到数据变化<li>监听到变化之后通知订阅者，需要实现一个消息订阅器Dep，通过维护一个数组subs，用来收集订阅者，数据变动触发notify，再调用订阅者watcher的update方法<blockquote><p>并不是每次数据修改就会立刻调用watcher的update方法，首先会调用一个queueWatcher方法，将这些watcher先添加到一个队列中，相同的watcher只会保留一个。最终在nextTick方法中执行</p></blockquote></ul><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">defineReactive</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//闭包</span>
    <span class="kd">let</span> <span class="nx">childDep</span> <span class="o">=</span> <span class="nx">observe</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dep</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dep</span><span class="p">()</span> <span class="c1">//每个属性都有一个dep</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
        <span class="kd">get</span><span class="p">()</span> <span class="p">{</span> <span class="c1">//依赖收集</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">Dep</span><span class="p">.</span><span class="nx">target</span><span class="p">){</span>
                <span class="nx">dep</span><span class="p">.</span><span class="nx">depend</span><span class="p">()</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">childDep</span><span class="p">){</span>
                    <span class="nx">childDep</span><span class="p">.</span><span class="nx">dep</span><span class="p">.</span><span class="nx">depend</span><span class="p">()</span> <span class="c1">//数组或者对象存起来了渲染watcher</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`读取了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">value</span>
        <span class="p">},</span>
        <span class="kd">set</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//依赖更新</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`设置了</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">属性`</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">newValue</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span> <span class="k">return</span>
            <span class="nx">observe</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span>
            <span class="nx">dep</span><span class="p">.</span><span class="nx">notify</span><span class="p">()</span> <span class="c1">//触发更新</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">class</span> <span class="nx">Dep</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="nx">depend</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">Dep</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">addDep</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>  <span class="c1">//实现双向记忆dep和watcher互相记忆</span>
        <span class="c1">// this.subs.push(Dep.target)</span>
        <span class="c1">// console.log(this.subs)</span>
    <span class="p">}</span>
    <span class="nx">addSub</span><span class="p">(</span><span class="nx">watcher</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">notify</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">watcher</span> <span class="o">=&gt;</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">update</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Dep</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">null</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">pushTarget</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Dep</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">watcher</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">popTarget</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Dep</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">}</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">popTarget</span><span class="p">,</span> <span class="nx">pushTarget</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./dep</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">nextTick</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../util</span><span class="dl">"</span>
<span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">class</span> <span class="nx">Watcher</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">exprOrFn</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">vm</span> <span class="o">=</span> <span class="nx">vm</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">user</span> <span class="c1">//用户watcher</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">isWatcher</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">options</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">boolean</span><span class="dl">"</span> <span class="c1">//渲染watcher</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exprOrFn</span> <span class="o">=</span> <span class="nx">exprOrFn</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="o">++</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">depsId</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Set</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exprOrFn</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getter</span> <span class="o">=</span> <span class="nx">exprOrFn</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">exprOrFn</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">.</span><span class="dl">"</span><span class="p">)</span>
                <span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">vm</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">path</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">obj</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kd">get</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">addDep</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">depsId</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depsId</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
            <span class="nx">dep</span><span class="p">.</span><span class="nx">addSub</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">debugger</span>
        <span class="nx">pushTarget</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getter</span><span class="p">()</span>
        <span class="nx">popTarget</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="nx">result</span>
    <span class="p">}</span>
    <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">debugger</span>
        <span class="kd">let</span> <span class="nx">newValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kd">get</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">newValue</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//这里不能每次一更改数据就调用，</span>
        <span class="nx">queueWatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="c1">// this.get()</span>
        <span class="c1">// this.cb.call(this.vm)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 *  批处理操作，等所有的同步任务完成后再执行
 * 相同的watcher只保留一个
 */</span>

<span class="kd">function</span> <span class="nx">flushSchedulerQueue</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">watcher</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">watcher</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
        <span class="c1">// if (watcher.isWatcher) {</span>
        <span class="c1">//     watcher.cb()</span>
        <span class="c1">// }</span>

    <span class="p">})</span>
    <span class="nx">has</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">queue</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">pending</span> <span class="o">=</span> <span class="kc">false</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">queue</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">let</span> <span class="nx">has</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">let</span> <span class="nx">pending</span> <span class="o">=</span> <span class="kc">false</span>
<span class="kd">function</span> <span class="nx">queueWatcher</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">id</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span>
        <span class="nx">has</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pending</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nextTick</span><span class="p">(</span><span class="nx">flushSchedulerQueue</span><span class="p">)</span>
            <span class="nx">pending</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">//防抖</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//nextTick原理涉及到微任务和宏任务</span>
<span class="kd">let</span> <span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">let</span> <span class="nx">pending</span> <span class="o">=</span> <span class="kc">false</span>
<span class="kd">let</span> <span class="nx">flushCallbacks</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">callbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="nx">cb</span><span class="p">())</span>
    <span class="nx">pending</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">timerFunc</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">Promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timerFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">flushCallbacks</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">setImmediate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timerFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">setImmediate</span><span class="p">(</span><span class="nx">flushCallbacks</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">MutationObserver</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//可以监控dom变化，监控完毕后异步更新</span>
    <span class="kd">let</span> <span class="nx">observe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="nx">flushCallbacks</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">textNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">observe</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">textNode</span><span class="p">,</span> <span class="p">{</span> <span class="na">characterData</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="nx">timerFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">textNode</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">timerFunc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">flushCallbacks</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">nextTick</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">debugger</span>
    <span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pending</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">timerFunc</span><span class="p">()</span> <span class="c1">//异步</span>
        <span class="nx">pending</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="4virturl-dom">4.virturl dom</h2><blockquote><p>Virtual DOM 其实就是一棵以 JavaScript 对象( VNode 节点)作为基础的树，用对象属性来描述节点，实际上它只是一层对真实 DOM 的抽象。最终可以通过一系列操作使这棵树映射到真实环境上。</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//一个完整的vnode节点包含的信息</span>
<span class="p">{</span>
    <span class="nl">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">,</span> <span class="c1">//节点的标签</span>
    <span class="nx">el</span><span class="p">:</span> <span class="dl">"</span><span class="s2">div#app</span><span class="dl">"</span><span class="p">,</span> <span class="c1">//对真实节点的引用</span>
    <span class="nx">text</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">//如果是文本节点，对应文本节点的textContent</span>
    <span class="nx">data</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">//属性</span>
    <span class="nx">children</span><span class="p">:</span> <span class="p">[]</span> <span class="c1">//自节点</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="5dom-diff">5.dom diff</h2><blockquote><p>主要是新旧虚拟节点做对比来进行更新。先同级进行比较，再递归比较子节点。</p><h4 id="1先判断是否是相同标签如果不相同则直接替换否则进入具体对比">1.先判断是否是相同标签，如果不相同，则直接替换，否则进入具体对比</h4></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">patch</span> <span class="p">(</span><span class="nx">oldVnode</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">oldVnode</span><span class="p">.</span><span class="nx">tag</span> <span class="o">!==</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
       <span class="c1">//1.比较标签，标签不一样，直接替换</span>
        <span class="k">return</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">createEle</span><span class="p">(</span><span class="nx">vnode</span><span class="p">),</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">//2.标签一样，比较文本&lt;div&gt;111&lt;/div&gt;   &lt;div&gt;12&lt;/div&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oldVnode</span><span class="p">.</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//文本比对</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oldVnode</span><span class="p">.</span><span class="nx">text</span> <span class="o">!==</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">text</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//3.标签一样，需要开始对比属性和儿子。标签一样直接复用老节点，再更新差异即可</span>
    <span class="kd">let</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">el</span> <span class="c1">//复用老节点</span>
     <span class="c1">//更新属性</span>
    <span class="nx">updateProperties</span><span class="p">(</span><span class="nx">vnode</span><span class="p">,</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="c1">//比较儿子</span>
    <span class="kd">let</span> <span class="nx">oldChildren</span> <span class="o">=</span> <span class="nx">oldVnode</span><span class="p">.</span><span class="nx">children</span>
    <span class="kd">let</span> <span class="nx">newChildren</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">children</span>
    <span class="c1">//老得有儿子，新的没有</span>
    <span class="c1">//老得没有儿子，新的有</span>
    <span class="c1">//新的老得都有儿子</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">oldChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">newChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">updateChildren</span><span class="p">(</span><span class="nx">oldChildren</span><span class="p">,</span> <span class="nx">newChildren</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">oldChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">""</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">newChildren</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
            <span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">createEle</span><span class="p">(</span><span class="nx">child</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>新旧节点都有儿子的情况是核心的diff算法，采用双指针diff算法。</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">//情况1: 新节点只是在尾部比老节点多了一部分或者少了一部分，别的节点都相同</span>
<span class="c1">//假设根据一下模版生成vnode1和vnode2,先暂时不考虑key，有没有key对这种情况没影响</span>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="c1">//vnode2</span>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: purple</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">E</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span><span class="nx">vnode1</span><span class="p">,</span> <span class="nx">vnode2</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
</pre></table></code></div></div><blockquote><p>情况1:新节点只是在尾部比老节点多了一部分或者少了一部分节点，别的节点都相同。此时采用头头比较，从头指针A节点开始比较，同时循环新旧节点，哪个先结束，循环就停止，将多余的删除或者添加进去</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/1.png" alt="diff" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldVnode</span><span class="p">,</span> <span class="nx">newVnode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">oldVnode</span><span class="p">.</span><span class="nx">tag</span> <span class="o">==</span> <span class="nx">newVnode</span><span class="p">.</span><span class="nx">tag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">oldVnode</span><span class="p">.</span><span class="nx">key</span> <span class="o">==</span> <span class="nx">newVnode</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">updateChildren</span><span class="p">(</span><span class="nx">oldChildren</span><span class="p">,</span> <span class="nx">newChildren</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">oldStartIndex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">let</span> <span class="nx">oldStartVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">let</span> <span class="nx">oldEndIndex</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kd">let</span> <span class="nx">oldEndVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">oldEndIndex</span><span class="p">]</span>

    <span class="kd">let</span> <span class="nx">newStartIndex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">let</span> <span class="nx">newStartVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">let</span> <span class="nx">newEndIndex</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kd">let</span> <span class="nx">newEndVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="nx">newEndIndex</span><span class="p">]</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">newStartIndex</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">oldStartIndex</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
            <span class="c1">//头头比较</span>
            <span class="nx">patch</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)</span>
            <span class="nx">oldStartVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="o">++</span><span class="nx">oldStartIndex</span><span class="p">]</span>
            <span class="nx">newStartVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="o">++</span><span class="nx">newStartIndex</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">循环结束后</span><span class="err">，</span><span class="nx">看下图</span><span class="err">，</span><span class="nx">新的虚拟节点比老的多了一个节点</span><span class="err">，</span><span class="nx">直接将多出的部分插入到当前新节点的尾节点的下一个之前</span><span class="p">(</span><span class="nx">向后添加</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/2.png" alt="diff" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">newStartIndex</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">newStartIndex</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//可能是向前添加或者向后</span>
        <span class="c1">// parent.appendChild(createEle(newChildren[i]))</span>
        <span class="c1">//</span>
        <span class="kd">let</span> <span class="nx">ele</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="nx">newEndIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="nx">newChildren</span><span class="p">[</span><span class="nx">newEndIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">el</span>
        <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">createEle</span><span class="p">(</span><span class="nx">newChildren</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">ele</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>情况2:新旧节点尾部相同，采用尾尾比较 ```js</p></blockquote><div><li style="background: pink">A<li style="background: yellow">B<li style="background: blue">C<li style="background: green">D</div><p>//vnode2</p><div><li style="background: purple">E<li style="background: pink">A<li style="background: yellow">B<li style="background: blue">C<li style="background: green">D</div><p>setTimeout(() =&gt; { patch(vnode1, vnode2) }, 2000)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>
```js
while (newStartIndex &lt;= newEndIndex &amp;&amp; oldStartIndex &lt;= oldEndIndex){
    if(isSameVnode(oldStartVnode, newStartVnode)){
        //头头比较
        patch(oldStartVnode, newStartVnode)
        oldStartVnode = oldChildren[++oldStartIndex]
        newStartVnode = newChildren[++newStartIndex]
    }else if(isSameVnode(oldEndVnode, newEndVnode)){
         //尾尾比较
        patch(oldEndVnode, newEndVnode)
        oldEndVnode = oldChildren[--oldEndIndex]
        newEndVnode = newChildren[--newEndIndex]
    }
}
//循环开始图和图1相同，结束后，看下图
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/3.png" alt="diff" /></p><blockquote><p>情况3:头和尾比较,通过移动老节点来实现。</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="c1">//vnode2</span>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span><span class="nx">vnode1</span><span class="p">,</span> <span class="nx">vnode2</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/4.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/5.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/6.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/7.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/8.png" alt="diff" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="nx">newStartIndex</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">oldStartIndex</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
        <span class="c1">//头头比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
         <span class="c1">//尾尾比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
        <span class="c1">//头尾比较</span>
        <span class="nx">patch</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)</span>
        <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">oldEndVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span>
        <span class="nx">oldStartVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="o">++</span><span class="nx">oldStartIndex</span><span class="p">]</span>
        <span class="nx">newEndVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="o">--</span><span class="nx">newEndIndex</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>情况4:尾和头比较</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="c1">//vnode2</span>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">B</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span><span class="nx">vnode1</span><span class="p">,</span> <span class="nx">vnode2</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/9.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/10.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/11.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/12.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/13.png" alt="diff" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="nx">newStartIndex</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">oldStartIndex</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
        <span class="c1">//头头比较</span>
       <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
         <span class="c1">//尾尾比较</span>
       <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
        <span class="c1">//头尾比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
         <span class="c1">//尾 头比较</span>
        <span class="nx">patch</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)</span>
        <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
        <span class="nx">oldEndVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="o">--</span><span class="nx">oldEndIndex</span><span class="p">]</span>
        <span class="nx">newStartVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="o">++</span><span class="nx">newStartIndex</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>情况5:就是儿子之间不能找到明显的关系，这个时候要用新节点不停的去老节点里面找，找到就移动以复用节点</p></blockquote><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">D</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">D</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">E</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">E</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">M</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">M</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="c1">//vnode2</span>
<span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: pink</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">A</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: yellow</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">C</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: blue</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">E</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">E</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">background: green</span><span class="dl">"</span> <span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">Q</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Q</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">patch</span><span class="p">(</span><span class="nx">vnode1</span><span class="p">,</span> <span class="nx">vnode2</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/14.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/15.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/16.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/17.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/18.png" alt="diff" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/sample/19.png" alt="diff" /></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="nx">newStartIndex</span> <span class="o">&lt;=</span> <span class="nx">newEndIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">oldStartIndex</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
       <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
         <span class="c1">//尾尾比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldStartVnode</span><span class="p">,</span> <span class="nx">newEndVnode</span><span class="p">)){</span>
        <span class="c1">//头尾比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isSameVnode</span><span class="p">(</span><span class="nx">oldEndVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)){</span>
         <span class="c1">//尾 头比较</span>
        <span class="c1">//...</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="kd">let</span> <span class="nx">moveIndex</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">newStartVnode</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">moveIndex</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//不需要移动，没有可复用的</span>
            <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">createEle</span><span class="p">(</span><span class="nx">newStartVnode</span><span class="p">),</span> <span class="nx">oldStartVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">moveVnode</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">moveIndex</span><span class="p">]</span> <span class="c1">//这个老得节点需要移动</span>
            <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">moveIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
            <span class="nx">parent</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">moveVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">oldStartVnode</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
            <span class="nx">patch</span><span class="p">(</span><span class="nx">moveVnode</span><span class="p">,</span> <span class="nx">newStartVnode</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">newStartVnode</span> <span class="o">=</span> <span class="nx">newChildren</span><span class="p">[</span><span class="o">++</span><span class="nx">newStartIndex</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">oldStartIndex</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//删除多余的老节点</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">oldStartIndex</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">oldEndIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">child</span> <span class="o">=</span> <span class="nx">oldChildren</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">patch</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="为什么要用key">为什么要用key？</h4><blockquote><p>分析情况3，如果不使用key，在比较第一个li的时候，就会直接复用老节点的第一个li，然后再进一步把D更新为A。如果加上key属性，则只需要复用老节点，通过移动老节点来达到目的，他能通过key来精准的找到可以复用的节点。这样性能会高一些。</p></blockquote><h4 id="不能用index作为key">不能用index作为key</h4><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">v</span><span class="o">-</span><span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">(item, index) in list</span><span class="dl">"</span> <span class="p">:</span><span class="nx">key</span><span class="o">=</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/template</span><span class="err">&gt;
</span>
<span class="kd">const</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Person1</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Person2</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Person3</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span><span class="dl">"</span><span class="s2">Person4</span><span class="dl">"</span>
    <span class="p">}</span>
<span class="p">];</span>
</pre></table></code></div></div><ul><li>原因1和使用key的原因相同。<li>原因2:删除列表其中一个元素Person2后，会造成Person3和Person4重新渲染（因为key变了）。<li>原因3:如果此时 list 的 item 是 select 的选项，其中 Person3 是选中的，这个时候 Person2 被删除了，用 index 作为 key 就会变成是 Person4 选中的了，这就产生了bug。</ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/vue/" class="post-tag no-text-decoration" >vue</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=vue - jyy&url=http://localhost:4000/posts/vue/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=vue - jyy&u=http://localhost:4000/posts/vue/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=vue - jyy&url=http://localhost:4000/posts/vue/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/webpack/">webpack</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/js/">js</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/xss-csrf/"><div class="card-body"> <span class="timeago small" > Mar 12 <i class="unloaded">2021-03-12T11:10:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>xss和csrf</h3><div class="text-muted small"><p> xss</p></div></div></a></div><div class="card"> <a href="/posts/cookie/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2021-02-26T12:10:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>cookie session</h3><div class="text-muted small"><p> cookie 定义：是在客户端上存储的一个简单的文本文件。这个文件与特定的 Web 网站关联在一起, 保存了该客户机访问这个Web 网站时的信息。 同域的网站浏览器默认会自动携带cookie，子域和主域也不能共享cookie，可以设置domain属性为基础主域后才能实现cookie共享。 比如www.baidu.com和b.baidu.com不能共享cookie，可以设置domain...</p></div></div></a></div><div class="card"> <a href="/posts/cross-domain/"><div class="card-body"> <span class="timeago small" > Feb 25 <i class="unloaded">2021-02-25T11:10:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>cross domain</h3><div class="text-muted small"><p> 跨域：是指浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是浏览器对JavaScript实施的安全限制。 同源策略：是指协议，域名，端口都要相同，其中有一个不同都会产生跨域 如何解决跨域 1.jsonp 1.主要就是利用了 script 标签的src没有跨域限制来完成的 2.只能发送get请求 3.不安全，xss攻击 原理：前端自定义一个callback函数，...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/sort/" class="btn btn-outline-primary"><p>排序</p></a> <a href="/posts/write-a-new-post/" class="btn btn-outline-primary"><p>第一篇博客</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/username">your_full_name</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/webpack/">webpack</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/js/">js</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
