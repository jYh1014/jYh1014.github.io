I"ê%<h2 id="promiseä»‹ç»">promiseä»‹ç»</h2>
<blockquote>
  <p><strong>1.promiseæ˜¯ä»€ä¹ˆ?</strong> <br />
promiseå¯¹è±¡æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ã€‚</p>
</blockquote>

<blockquote>
  <p><strong>2.promiseçš„åº”ç”¨åœºæ™¯</strong> <br />
Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ä¸»è¦æ˜¯ä¸ºäº†è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ã€‚ä¸‹é¢æ¥çœ‹ä¸ªå›è°ƒåµŒå¥—çš„å°ä¾‹å­ï¼š</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> --><td class="rouge-code"><pre>fs.readFile("name.txt", "utf8", function(err,data){
    if(data){
        fs.readFile(data, "utf8", function(err1,data1){
            // console.log(err1,data1)
        })
    }
})
æ”¹é€ æˆpromiseåï¼Œç”¨é“¾å¼è°ƒç”¨çš„æ–¹å¼ã€‚
function readFile(...args) {
    return new Promise((resolve, reject) =&gt; {
        fs.readFile(...args, (err, data) =&gt; {
            if(err) reject(err)
            resolve(data)
        })
    })
}
readFile("name.txt", "utf8").then(data =&gt; {
    return readFile(data, "utf8");
}, err =&gt; {
    console.log("err1"+err)
})
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p><strong>3.promiseåŸç†</strong></p>
</blockquote>

<p>é¦–å…ˆå®ç°ä¸€ä¸ªæœ€ç®€å•çš„ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td> --><td class="rouge-code"><pre>let promise = new Promise((resolve, reject) =&gt; {
    resolve("ok")
})
promise.then(data =&gt; {
    console.log(â€œsuccess: " + data)
}, err =&gt; {
    console.log("error: " + err)
})
æºç å®ç°å¦‚ä¸‹ï¼š
class Promise {
    constructor(executor){
        this.value = undefined
        this.reason = undefined
        let resolve = (value) =&gt; {
            this.value = value
        }
        let reject = (reason) =&gt; {
            this.reason = reason
        }
        executor(resolve, reject)
    }
    then(onfulfilled, onreject){
        onfulfilled(this.value)
    }
}
module.exports = Promise
</pre></td></tr></tbody></table></code></pre></div></div>
<p>resolveæ˜¯å¼‚æ­¥æ“ä½œæˆåŠŸåæ‰§è¡Œçš„ï¼Œå¦‚æœå¼‚æ­¥æ“ä½œå¤±è´¥åˆ™è¦æ‰§è¡Œreject,æ­¤æ—¶å°±è¦è€ƒè™‘åŠ çŠ¶æ€ï¼ŒæˆåŠŸâ€FULFILLEDâ€ã€å¤±è´¥â€REJECTEDâ€ã€è¿›è¡Œä¸­â€PENDDINGâ€</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> --><td class="rouge-code"><pre>let promise = new Promise((resolve, reject) =&gt; {
    reject("å‡ºé”™äº†")
})
æºç å®ç°ï¼š
const PENDDING = "PENDDING"
const FULFILLED = "FULFILLED"
const REJECTED = "REJECTED"
class Promise{
    constructor(executor){
        this.value = undefined
        this.reason = undefined
        this.status = undefined
        let resolve = (value) =&gt; {
            this.value = value
            this.status = FULFILLED 
        }
        let reject = (reason) =&gt; {
            this.reason = reason
            this.status = REJECTED
        }
        executor(resolve, reject)
    }
    then(onfulfilled, onreject){
        if(this.status === FULFILLED){
            onfulfilled(this.value)
        }
        if(this.status === REJECTED){
            onreject(this.reason)
        }
        
    }
}
module.exports = Promise
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åˆ°æ­¤ä¸€ä¸ªç®€å•çš„promiseæºç å·²ç»å·®ä¸å¤šäº†ï¼Œä½†æ˜¯å®é™…åº”ç”¨ä¸­å¾€å¾€å¾ˆå¤æ‚ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å’Œå®šæ—¶å™¨çš„ç»„åˆã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td> --><td class="rouge-code"><pre>let promise = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
        resolve("ok")
    },1000)
})
promise.then(data =&gt; {
    console.log(â€œsuccess: " + data)
}, err =&gt; {
    console.log("error: " + err)
})
è¿™ç§æƒ…å†µéœ€è¦åˆ©ç”¨resolveCallbackså’ŒrejectCallbacksæ¥åšä¸€ä¸ªç¼“å­˜ã€‚

class Promise{
    constructor(executor){
        this.value = undefined
        this.reason = undefined
        this.status = PENDDING
        this.resolveCallbacks = []
        this.rejectCallbacks = []
        let resolve = (value) =&gt; {
            this.value = value
            this.status = FULFILLED 
            this.resolveCallbacks.forEach(fn =&gt; fn())
        }
        let reject = (reason) =&gt; {
            this.reason = reason
            this.status = REJECTED
            this.rejectCallbacks.forEach(fn =&gt; fn())
        }
        executor(resolve, reject)
    }
    then(onfulfilled, onreject){
        if(this.status === FULFILLED){
            onfulfilled(this.value)
        }
        if(this.status === REJECTED){
            onreject(this.reason)
        }
        if(this.status === PENDDING){
            this.resolveCallbacks.push(() =&gt; {
                onfulfilled(this.value)
            })
            this.rejectCallbacks.push(() =&gt; {
                onreject(this.reason)
            })
        }
    }
}
module.exports = Promise
</pre></td></tr></tbody></table></code></pre></div></div>
<p>es6æ–‡æ¡£ä¸Šå†™çš„promiseå…¶ä¸­ä¸€ä¸ªç‰¹ç‚¹æ˜¯ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä½†æ˜¯çœ‹ä¸‹é¢ä»£ç ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre></td> --><td class="rouge-code"><pre>let promise = new Promise((resolve, reject) =&gt; {
    resolve("ok")
    reject("å‡ºé”™äº†")
})
promise.then(data =&gt; {
    console.log(â€œsuccess: " + data)
}, err =&gt; {
    console.log("error: " + err)
})
promiseçš„æœ€ç»ˆçŠ¶æ€ç«Ÿç„¶æ˜¯rejectï¼Œæ­£ç¡®çš„çŠ¶æ€åº”è¯¥æ˜¯resolveã€‚
ä¿®æ”¹ä¸€ä¸‹æºç ï¼š

class Promise {
    constructor(executor) {
        this.value = undefined
        this.reason = undefined
        this.status = PENDDING
        this.resolveCallbacks = []
        this.rejectCallbacks = []
        let resolve = (value) =&gt; {
            if (this.status === PENDDING) {
                this.value = value
                this.status = FULFILLED
                this.resolveCallbacks.forEach(fn =&gt; fn())
            }
        }
        let reject = (reason) =&gt; {
            if (this.status === PENDDING) {
                this.reason = reason
                this.status = REJECTED
                this.rejectCallbacks.forEach(fn =&gt; fn())
            }
        }
        executor(resolve, reject)
    }
    then(onfulfilled, onreject) {
        ...
    }
}
module.exports = Promise

æ³¨æ„ï¼šthenæ–¹æ³•æ˜¯å¯ä»¥é“¾å¼è°ƒç”¨çš„ï¼Œæ‰€ä»¥thenæ–¹æ³•çš„è¿”å›å€¼åº”è¯¥æ˜¯ä¸€ä¸ªæ–°çš„promiseå®ä¾‹ã€‚
 then(onfulfilled, onreject) {
    let p = new Promise((resolve, reject) =&gt; {
        if (this.status === FULFILLED) {
            onfulfilled(this.value)
        }
        if (this.status === REJECTED) {
            onreject(this.reason)
        }
        if (this.status === PENDDING) {
            this.resolveCallbacks.push(() =&gt; {
                onfulfilled(this.value)
            })
            this.rejectCallbacks.push(() =&gt; {
                onreject(this.reason)
            })
        }
    })
    return p
}

å†çœ‹ä¸‹é¢è¿™ç§æƒ…å†µï¼Œthenæ–¹æ³•é‡Œé¢è¿”å›çš„æ˜¯ä¸€ä¸ªpromiseï¼Œæ­¤æ—¶è¦å¯¹thenæ–¹æ³•å¯¹è¿”å›å€¼åšä¸€ä¸‹åˆ¤æ–­ï¼Œç„¶åè¿›è¡Œä¸åŒçš„å¤„ç†ï¼š
let promise = new Promise((resolve, reject) =&gt; {
    resolve("ok1")
})
let p1 = promise.then(data =&gt; {
    console.log("success1:" + data)
    return new Promise((resolve, reject) =&gt; {
        resolve("ok2")
    })
}, err =&gt; {
    console.log("error1: "+err)
})
let p2 = p1.then(data =&gt; {
    console.log("success2:" + data)
}, err =&gt; {
    console.log("error2: "+err)
})
è§£å†³å¦‚ä¸‹ï¼š
    then(onfulfilled, onreject) {
        let p = new Promise((resolve, reject) =&gt; {
            if (this.status === FULFILLED) {
                setTimeout(() =&gt; {
                    try{
                        let x = onfulfilled(this.value)
                        resolvePromise(p, x, resolve, reject)
                    }catch(e){
                        reject(e)
                    }
                })
                
                
            }
            if (this.status === REJECTED) {
                onreject(this.reason)
            }
            if (this.status === PENDDING) {
                this.resolveCallbacks.push(() =&gt; {
                    onfulfilled(this.value)
                })
                this.rejectCallbacks.push(() =&gt; {
                    onreject(this.reason)
                })
            }
        })
        return p
    }
</pre></td></tr></tbody></table></code></pre></div></div>
:ET