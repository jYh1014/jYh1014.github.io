I"Óx<h2 id="iteratoréå†å™¨">iteratoréå†å™¨</h2>

<blockquote>
  <p>es6ä¸Šæ˜¯è¿™æ ·å®šä¹‰çš„ï¼šå®ƒæ˜¯ä¸€ç§æ¥å£ï¼Œä¸ºå„ç§ä¸åŒçš„æ•°æ®ç»“æ„æä¾›ç»Ÿä¸€çš„è®¿é—®æœºåˆ¶ã€‚ä»»ä½•æ•°æ®ç»“æ„åªè¦éƒ¨ç½² Iterator æ¥å£ï¼Œå°±å¯ä»¥å®Œæˆéå†æ“ä½œ</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> --><td class="rouge-code"><pre>æ¨¡æ‹Ÿä¸€ä¸ªéå†å™¨ç”Ÿå­˜å‡½æ•°
<span class="k">function </span>makeIterator<span class="o">(</span>arr<span class="o">){</span>
    <span class="nb">let </span>index <span class="o">=</span> 0
    <span class="k">return</span> <span class="o">{</span>
        next: <span class="k">function</span><span class="o">(){</span>
            <span class="k">if</span><span class="o">(</span>index &lt; arr.length<span class="o">){</span>
                <span class="k">return</span> <span class="o">{</span>
                    value: arr[index++],
                    <span class="k">done</span>: <span class="nb">false</span>
                <span class="o">}</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">return</span> <span class="o">{</span>
                    value: undefined,
                    <span class="k">done</span>: <span class="nb">true</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nb">let </span>it <span class="o">=</span> makeIterator<span class="o">([</span><span class="s2">"a"</span>,<span class="s2">"b"</span><span class="o">])</span>
console.log<span class="o">(</span>it.next<span class="o">())</span>
console.log<span class="o">(</span>it.next<span class="o">())</span>
console.log<span class="o">(</span>it.next<span class="o">())</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ES6 è§„å®šï¼Œé»˜è®¤çš„ Iterator æ¥å£éƒ¨ç½²åœ¨æ•°æ®ç»“æ„çš„Symbol.iteratorå±æ€§ï¼Œæˆ–è€…è¯´ï¼Œä¸€ä¸ªæ•°æ®ç»“æ„åªè¦å…·æœ‰Symbol.iteratorå±æ€§ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯â€œå¯éå†çš„â€.<br />
åŸç”Ÿå…·å¤‡ Iterator æ¥å£çš„æ•°æ®ç»“æ„å¦‚ä¸‹:</p>
<ul>
  <li>Array</li>
  <li>Map</li>
  <li>Set</li>
  <li>String</li>
  <li>TypedArray</li>
  <li>å‡½æ•°çš„ arguments å¯¹è±¡</li>
  <li>NodeList å¯¹è±¡</li>
</ul>

<p>ä¸‹é¢æ˜¯ä¸ºä¸€ä¸ªå¯¹è±¡æ·»åŠ iteratoræ¥å£çš„ä¾‹å­</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> --><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">[</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">world</span><span class="dl">'</span> <span class="p">],</span>
  <span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nb">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="na">value</span><span class="p">:</span> <span class="nb">self</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">],</span>
            <span class="na">done</span><span class="p">:</span> <span class="kc">false</span>
          <span class="p">};</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="na">done</span><span class="p">:</span> <span class="kc">true</span> <span class="p">};</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="generatorå‡½æ•°">generatorå‡½æ•°</h2>

<blockquote>
  <p>åœ¨äº†è§£äº†å›è°ƒå‡½æ•°å’Œpromiseè§£å†³å¼‚æ­¥ç¼–ç¨‹çš„ä¸è¶³ä¹‹åï¼Œgeneratorå‡½æ•°å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ã€‚
è¿˜æœ‰ä¸€ç§å¤„ç†å¼‚æ­¥ç¼–ç¨‹çš„æ–¹æ¡ˆå«åšåç¨‹ï¼šæ„æ€æ˜¯å¤šä¸ªçº¿ç¨‹äº’ç›¸åä½œï¼Œå®Œæˆå¼‚æ­¥ä»»åŠ¡ã€‚</p>
</blockquote>

<p>å®ƒçš„è¿è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
  <li>ç¬¬ä¸€æ­¥ï¼Œåç¨‹Aå¼€å§‹æ‰§è¡Œ</li>
  <li>ç¬¬äºŒæ­¥ï¼Œåç¨‹Aæ‰§è¡Œåˆ°ä¸€åŠï¼Œè¿›å…¥æš‚åœï¼Œæ‰§è¡Œæƒè½¬ç§»åˆ°åç¨‹B</li>
  <li>ç¬¬ä¸‰æ­¥ï¼Œï¼ˆä¸€æ®µæ—¶é—´åï¼‰åç¨‹Bäº¤è¿˜æ‰§è¡Œæƒ</li>
  <li>ç¬¬å››æ­¥ï¼Œåç¨‹Aæ¢å¤æ‰§è¡Œ</li>
</ul>

<p>ä¸Šé¢æµç¨‹çš„åç¨‹Aï¼Œå°±æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œå› ä¸ºå®ƒåˆ†æˆä¸¤æ®µï¼ˆæˆ–å¤šæ®µï¼‰æ‰§è¡Œã€‚
Generator å‡½æ•°æ˜¯åç¨‹åœ¨ ES6 çš„å®ç°ï¼Œæœ€å¤§ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒï¼ˆå³æš‚åœæ‰§è¡Œï¼‰,yieldå‘½ä»¤æ˜¯å¼‚æ­¥ä¸¤ä¸ªé˜¶æ®µçš„åˆ†ç•Œçº¿ã€‚</p>

<p>ä¸‹é¢çœ‹ä¸€ä¸ªç”¨Generator å‡½æ•°æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ä¾‹å­ï¼š</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> --><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-fetch</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">gen</span><span class="p">(){</span>
  <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://api.github.com/users/github</span><span class="dl">'</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">bio</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>

<span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">å¯ä»¥çœ‹å‡ºè™½ç„¶</span> <span class="nx">Generator</span> <span class="nx">å‡½æ•°å°†å¼‚æ­¥æ“ä½œè¡¨ç¤ºå¾—å¾ˆç®€æ´</span><span class="err">ï¼Œ</span><span class="nx">ä½†æ˜¯æµç¨‹ç®¡ç†å´ä¸æ–¹ä¾¿</span><span class="err">ã€‚</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>es6æ–‡æ¡£ä¸ŠæŒ‡å‡ºthunkå‡½æ•°å¯ä»¥ç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†ã€‚</p>

<h2 id="thunkå‡½æ•°">Thunkå‡½æ•°</h2>

<blockquote>
  <p>ç¼–è¯‘å™¨çš„â€œä¼ åè°ƒç”¨â€å®ç°ï¼Œæ˜¯å°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶å‡½æ•°ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ã€‚è¿™ä¸ªä¸´æ—¶å‡½æ•°å°±å«åš Thunk å‡½æ•°</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> --><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">m</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">f</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>

<span class="c1">// ç­‰åŒäº</span>

<span class="kd">let</span> <span class="nx">thunk</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">thunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">thunk</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>JavaScript è¯­è¨€æ˜¯ä¼ å€¼è°ƒç”¨,Thunk å‡½æ•°æ›¿æ¢çš„ä¸æ˜¯è¡¨è¾¾å¼ï¼Œè€Œæ˜¯å¤šå‚æ•°å‡½æ•°ï¼Œå°†å…¶æ›¿æ¢æˆä¸€ä¸ªåªæ¥å—å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°çš„å•å‚æ•°å‡½æ•°ã€‚
ä»»ä½•å‡½æ•°ï¼Œåªè¦å‚æ•°æœ‰å›è°ƒå‡½æ•°ï¼Œå°±èƒ½å†™æˆ Thunk å‡½æ•°çš„å½¢å¼</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> --><td class="rouge-code"><pre>// æ­£å¸¸ç‰ˆæœ¬çš„readFileï¼ˆå¤šå‚æ•°ç‰ˆæœ¬ï¼‰
fs.readFile<span class="o">(</span>fileName, callback<span class="o">)</span><span class="p">;</span>

// Thunkç‰ˆæœ¬çš„readFileï¼ˆå•å‚æ•°ç‰ˆæœ¬ï¼‰
<span class="nb">let </span>Thunk <span class="o">=</span> <span class="k">function</span> <span class="o">(</span>fileName<span class="o">)</span> <span class="o">{</span>
  <span class="k">return function</span> <span class="o">(</span>callback<span class="o">)</span> <span class="o">{</span>
    <span class="k">return </span>fs.readFile<span class="o">(</span>fileName, callback<span class="o">)</span><span class="p">;</span>
  <span class="o">}</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>

<span class="nb">let </span>readFileThunk <span class="o">=</span> Thunk<span class="o">(</span>fileName<span class="o">)</span><span class="p">;</span>
readFileThunk<span class="o">(</span>callback<span class="o">)</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="thunkify-æ¨¡å—">Thunkify æ¨¡å—</h2>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> --><td class="rouge-code"><pre><span class="c1">//ä½¿ç”¨æ–¹å¼ï¼šä»¥è¯»å–æ–‡ä»¶ä¸ºä¾‹</span>
<span class="kd">let</span> <span class="nx">thunkify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">thunkify</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">read</span> <span class="o">=</span> <span class="nx">thunkify</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>
<span class="nx">read</span><span class="p">(</span><span class="dl">'</span><span class="s1">package.json</span><span class="dl">'</span><span class="p">)(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">str</span><span class="p">){</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
<span class="c1">//æºç å®ç°ï¼š</span>
<span class="kd">function</span> <span class="nx">thunkify</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">called</span><span class="p">;</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">called</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">done</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="generator-å‡½æ•°çš„æµç¨‹ç®¡ç†">Generator å‡½æ•°çš„æµç¨‹ç®¡ç†</h2>
<blockquote>
  <p>Thunk å‡½æ•°ç°åœ¨å¯ä»¥ç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> --><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">thunkify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">thunkify</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">readFileThunk</span> <span class="o">=</span> <span class="nx">thunkify</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">gen</span> <span class="o">=</span> <span class="kd">function</span><span class="o">*</span> <span class="p">(){</span>
  <span class="kd">let</span> <span class="nx">r1</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="dl">'</span><span class="s1">/etc/fstab</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r1</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
  <span class="kd">let</span> <span class="nx">r2</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="dl">'</span><span class="s1">/etc/shells</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r2</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="p">};</span>
<span class="c1">//å…ˆçœ‹å¦‚ä½•æ‰‹åŠ¨æ‰§è¡Œä¸Šé¢è¿™ä¸ª Generator å‡½æ•°</span>
<span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">r1</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="nx">r1</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">r2</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">r2</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="c1">//å¯ä»¥å‘ç° Generator å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶å®æ˜¯å°†åŒä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåå¤ä¼ å…¥nextæ–¹æ³•çš„valueå±æ€§ã€‚</span>
<span class="nx">è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨é€’å½’æ¥è‡ªåŠ¨å®Œæˆè¿™ä¸ªè¿‡ç¨‹</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="thunk-å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†">Thunk å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td> --><td class="rouge-code"><pre><span class="c1">//åŸºäº Thunk å‡½æ•°çš„ Generator æ‰§è¡Œå™¨</span>
<span class="kd">function</span> <span class="nx">run</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">();</span>
<span class="c1">//nextå°±æ˜¯thunkå‡½æ•°çš„å›è°ƒå‡½æ•°</span>
  <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">g</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nx">run</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>

<span class="c1">//å‰ææ˜¯æ¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œéƒ½è¦æ˜¯ Thunk å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿåœ¨yieldå‘½ä»¤åé¢çš„å¿…é¡»æ˜¯ Thunk å‡½æ•°</span>
<span class="kd">let</span> <span class="nx">g</span> <span class="o">=</span> <span class="kd">function</span><span class="o">*</span> <span class="p">(){</span>
  <span class="kd">let</span> <span class="nx">f1</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="dl">'</span><span class="s1">fileA</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">f2</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="dl">'</span><span class="s1">fileB</span><span class="dl">'</span><span class="p">);</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">readFileThunk</span><span class="p">(</span><span class="dl">'</span><span class="s1">fileN</span><span class="dl">'</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">run</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="coæ¨¡å—">coæ¨¡å—</h2>

<blockquote>
  <p>ç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œï¼Œcoæ¨¡å—çº¦å®šï¼Œyieldå‘½ä»¤åé¢åªèƒ½æ˜¯ Thunk å‡½æ•°æˆ– Promise å¯¹è±¡</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td> --><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">fs</span><span class="dl">"</span><span class="p">).</span><span class="nx">promises</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">read</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="dl">"</span><span class="s2">name.txt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">utf8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">age</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="dl">"</span><span class="s2">utf8</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">xx</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="nx">age</span> <span class="o">+</span> <span class="mi">20</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">xx</span>
<span class="p">}</span>
<span class="nx">co</span><span class="p">(</span><span class="nx">read</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1">//æºç å®ç°å¦‚ä¸‹ï¼š</span>
<span class="kd">function</span> <span class="nx">co</span><span class="p">(</span><span class="nx">gen</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">gen</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gen</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="p">{</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">done</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
                    <span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
                <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
            <span class="p">}</span>

        <span class="p">}</span>
        <span class="nx">next</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET