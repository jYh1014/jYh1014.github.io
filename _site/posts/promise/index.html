<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>promise原理 | jyy</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="promise原理" /><meta name="author" content="jyy" /><meta property="og:locale" content="en_US" /><meta name="description" content="promise介绍 1.promise是什么? promise对象是一个构造函数。" /><meta property="og:description" content="promise介绍 1.promise是什么? promise对象是一个构造函数。" /><link rel="canonical" href="http://localhost:4000/posts/promise/" /><meta property="og:url" content="http://localhost:4000/posts/promise/" /><meta property="og:site_name" content="jyy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-08T15:20:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="promise原理" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@jyy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"datePublished":"2020-07-08T15:20:00+08:00","dateModified":"2020-07-08T15:20:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/promise/"},"url":"http://localhost:4000/posts/promise/","author":{"@type":"Person","name":"jyy"},"description":"promise介绍 1.promise是什么? promise对象是一个构造函数。","@type":"BlogPosting","headline":"promise原理","@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">jyy</a></div><div class="site-subtitle font-italic"></div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/github_username" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['example','doamin.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>promise原理</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>promise原理</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 8, 2020, 3:20 PM +0800" > Jul 8, 2020 <i class="unloaded">2020-07-08T15:20:00+08:00</i> </span> by <span class="author"> jyy </span></div></div><div class="post-content"><h2 id="promise介绍">promise介绍</h2><blockquote><p><strong>1.promise是什么?</strong> <br /> promise对象是一个构造函数。</p></blockquote><blockquote><p><strong>2.promise的应用场景</strong> <br /> Promise 是异步编程的一种解决方案。主要是为了解决回调地狱的问题。下面来看个回调嵌套的小例子：</p></blockquote><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>fs.readFile<span class="o">(</span><span class="s2">"name.txt"</span>, <span class="s2">"utf8"</span>, <span class="k">function</span><span class="o">(</span>err,data<span class="o">){</span>
    <span class="k">if</span><span class="o">(</span>data<span class="o">){</span>
        fs.readFile<span class="o">(</span>data, <span class="s2">"utf8"</span>, <span class="k">function</span><span class="o">(</span>err1,data1<span class="o">){</span>
            // console.log<span class="o">(</span>err1,data1<span class="o">)</span>
        <span class="o">})</span>
    <span class="o">}</span>
<span class="o">})</span>
改造成promise后，用链式调用的方式。
<span class="k">function </span>readFile<span class="o">(</span>...args<span class="o">)</span> <span class="o">{</span>
    <span class="k">return </span>new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
        fs.readFile<span class="o">(</span>...args, <span class="o">(</span>err, data<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span>err<span class="o">)</span> reject<span class="o">(</span>err<span class="o">)</span>
            resolve<span class="o">(</span>data<span class="o">)</span>
        <span class="o">})</span>
    <span class="o">})</span>
<span class="o">}</span>
readFile<span class="o">(</span><span class="s2">"name.txt"</span>, <span class="s2">"utf8"</span><span class="o">)</span>.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    <span class="k">return </span>readFile<span class="o">(</span>data, <span class="s2">"utf8"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"err1"</span>+err<span class="o">)</span>
<span class="o">})</span>
</pre></table></code></div></div><blockquote><p><strong>3.promise原理</strong></p></blockquote><p>首先实现一个最简单的：</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    resolve<span class="o">(</span><span class="s2">"ok"</span><span class="o">)</span>
<span class="o">})</span>
promise.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success: "</span> + data<span class="o">)</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error: "</span> + err<span class="o">)</span>
<span class="o">})</span>
源码实现如下：
class Promise <span class="o">{</span>
    constructor<span class="o">(</span>executor<span class="o">){</span>
        this.value <span class="o">=</span> undefined
        this.reason <span class="o">=</span> undefined
        <span class="nb">let </span>resolve <span class="o">=</span> <span class="o">(</span>value<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.value <span class="o">=</span> value
        <span class="o">}</span>
        <span class="nb">let </span>reject <span class="o">=</span> <span class="o">(</span>reason<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.reason <span class="o">=</span> reason
        <span class="o">}</span>
        executor<span class="o">(</span>resolve, reject<span class="o">)</span>
    <span class="o">}</span>
    <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">){</span>
        onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
module.exports <span class="o">=</span> Promise
</pre></table></code></div></div><p>resolve是异步操作成功后执行的，如果异步操作失败则要执行reject,此时就要考虑加状态，成功”FULFILLED”、失败”REJECTED”、进行中”PENDDING”</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    reject<span class="o">(</span><span class="s2">"出错了"</span><span class="o">)</span>
<span class="o">})</span>
源码实现：
const PENDDING <span class="o">=</span> <span class="s2">"PENDDING"</span>
const FULFILLED <span class="o">=</span> <span class="s2">"FULFILLED"</span>
const REJECTED <span class="o">=</span> <span class="s2">"REJECTED"</span>
class Promise<span class="o">{</span>
    constructor<span class="o">(</span>executor<span class="o">){</span>
        this.value <span class="o">=</span> undefined
        this.reason <span class="o">=</span> undefined
        this.status <span class="o">=</span> undefined
        <span class="nb">let </span>resolve <span class="o">=</span> <span class="o">(</span>value<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.value <span class="o">=</span> value
            this.status <span class="o">=</span> FULFILLED 
        <span class="o">}</span>
        <span class="nb">let </span>reject <span class="o">=</span> <span class="o">(</span>reason<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.reason <span class="o">=</span> reason
            this.status <span class="o">=</span> REJECTED
        <span class="o">}</span>
        executor<span class="o">(</span>resolve, reject<span class="o">)</span>
    <span class="o">}</span>
    <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">){</span>
        <span class="k">if</span><span class="o">(</span>this.status <span class="o">===</span> FULFILLED<span class="o">){</span>
            onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>this.status <span class="o">===</span> REJECTED<span class="o">){</span>
            onreject<span class="o">(</span>this.reason<span class="o">)</span>
        <span class="o">}</span>
        
    <span class="o">}</span>
<span class="o">}</span>
module.exports <span class="o">=</span> Promise
</pre></table></code></div></div><p>到此一个简单的promise源码已经差不多了，但是实际应用中往往很复杂，最常见的就是和定时器的组合。</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    setTimeout<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
        resolve<span class="o">(</span><span class="s2">"ok"</span><span class="o">)</span>
    <span class="o">}</span>,1000<span class="o">)</span>
<span class="o">})</span>
promise.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success: "</span> + data<span class="o">)</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error: "</span> + err<span class="o">)</span>
<span class="o">})</span>
这种情况需要利用resolveCallbacks和rejectCallbacks来做一个缓存。

class Promise<span class="o">{</span>
    constructor<span class="o">(</span>executor<span class="o">){</span>
        this.value <span class="o">=</span> undefined
        this.reason <span class="o">=</span> undefined
        this.status <span class="o">=</span> PENDDING
        this.resolveCallbacks <span class="o">=</span> <span class="o">[]</span>
        this.rejectCallbacks <span class="o">=</span> <span class="o">[]</span>
        <span class="nb">let </span>resolve <span class="o">=</span> <span class="o">(</span>value<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.value <span class="o">=</span> value
            this.status <span class="o">=</span> FULFILLED 
            this.resolveCallbacks.forEach<span class="o">(</span>fn <span class="o">=&gt;</span> fn<span class="o">())</span>
        <span class="o">}</span>
        <span class="nb">let </span>reject <span class="o">=</span> <span class="o">(</span>reason<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            this.reason <span class="o">=</span> reason
            this.status <span class="o">=</span> REJECTED
            this.rejectCallbacks.forEach<span class="o">(</span>fn <span class="o">=&gt;</span> fn<span class="o">())</span>
        <span class="o">}</span>
        executor<span class="o">(</span>resolve, reject<span class="o">)</span>
    <span class="o">}</span>
    <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">){</span>
        <span class="k">if</span><span class="o">(</span>this.status <span class="o">===</span> FULFILLED<span class="o">){</span>
            onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>this.status <span class="o">===</span> REJECTED<span class="o">){</span>
            onreject<span class="o">(</span>this.reason<span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>this.status <span class="o">===</span> PENDDING<span class="o">){</span>
            this.resolveCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
            <span class="o">})</span>
            this.rejectCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                onreject<span class="o">(</span>this.reason<span class="o">)</span>
            <span class="o">})</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
module.exports <span class="o">=</span> Promise
</pre></table></code></div></div><p>es6文档上写的promise其中一个特点是一旦状态改变，就不会再变，但是看下面代码：</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
</pre><td class="rouge-code"><pre><span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    resolve<span class="o">(</span><span class="s2">"ok"</span><span class="o">)</span>
    reject<span class="o">(</span><span class="s2">"出错了"</span><span class="o">)</span>
<span class="o">})</span>
promise.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success: "</span> + data<span class="o">)</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error: "</span> + err<span class="o">)</span>
<span class="o">})</span>
promise的最终状态竟然是reject，正确的状态应该是resolve。
修改一下源码：

class Promise <span class="o">{</span>
    constructor<span class="o">(</span>executor<span class="o">)</span> <span class="o">{</span>
        this.value <span class="o">=</span> undefined
        this.reason <span class="o">=</span> undefined
        this.status <span class="o">=</span> PENDDING
        this.resolveCallbacks <span class="o">=</span> <span class="o">[]</span>
        this.rejectCallbacks <span class="o">=</span> <span class="o">[]</span>
        <span class="nb">let </span>resolve <span class="o">=</span> <span class="o">(</span>value<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> PENDDING<span class="o">)</span> <span class="o">{</span>
                this.value <span class="o">=</span> value
                this.status <span class="o">=</span> FULFILLED
                this.resolveCallbacks.forEach<span class="o">(</span>fn <span class="o">=&gt;</span> fn<span class="o">())</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nb">let </span>reject <span class="o">=</span> <span class="o">(</span>reason<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> PENDDING<span class="o">)</span> <span class="o">{</span>
                this.reason <span class="o">=</span> reason
                this.status <span class="o">=</span> REJECTED
                this.rejectCallbacks.forEach<span class="o">(</span>fn <span class="o">=&gt;</span> fn<span class="o">())</span>
            <span class="o">}</span>
        <span class="o">}</span>
        executor<span class="o">(</span>resolve, reject<span class="o">)</span>
    <span class="o">}</span>
    <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">)</span> <span class="o">{</span>
        ...
    <span class="o">}</span>
<span class="o">}</span>
module.exports <span class="o">=</span> Promise

注意：then方法是可以链式调用的，所以then方法的返回值应该是一个新的promise实例。
 <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">)</span> <span class="o">{</span>
    <span class="nb">let </span>p <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> FULFILLED<span class="o">)</span> <span class="o">{</span>
            onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> REJECTED<span class="o">)</span> <span class="o">{</span>
            onreject<span class="o">(</span>this.reason<span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> PENDDING<span class="o">)</span> <span class="o">{</span>
            this.resolveCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
            <span class="o">})</span>
            this.rejectCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                onreject<span class="o">(</span>this.reason<span class="o">)</span>
            <span class="o">})</span>
        <span class="o">}</span>
    <span class="o">})</span>
    <span class="k">return </span>p
<span class="o">}</span>

再看下面这种情况，then方法里面返回的是一个promise，此时要对then方法对返回值做一下判断，然后进行不同的处理：
<span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    resolve<span class="o">(</span><span class="s2">"ok1"</span><span class="o">)</span>
<span class="o">})</span>
<span class="nb">let </span>p1 <span class="o">=</span> promise.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success1:"</span> + data<span class="o">)</span>
    <span class="k">return </span>new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
        resolve<span class="o">(</span><span class="s2">"ok2"</span><span class="o">)</span>
    <span class="o">})</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error1: "</span>+err<span class="o">)</span>
<span class="o">})</span>
<span class="nb">let </span>p2 <span class="o">=</span> p1.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success2:"</span> + data<span class="o">)</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error2: "</span>+err<span class="o">)</span>
<span class="o">})</span>
解决如下：
    <span class="k">then</span><span class="o">(</span>onfulfilled, onreject<span class="o">)</span> <span class="o">{</span>
        <span class="nb">let </span>p <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> FULFILLED<span class="o">)</span> <span class="o">{</span>
                setTimeout<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                    try<span class="o">{</span>
                        <span class="nb">let </span>x <span class="o">=</span> onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
                        resolvePromise<span class="o">(</span>p, x, resolve, reject<span class="o">)</span>
                    <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
                        reject<span class="o">(</span>e<span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">})</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> REJECTED<span class="o">)</span> <span class="o">{</span>
                setTimeout<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                    try<span class="o">{</span>
                        <span class="nb">let </span>x <span class="o">=</span> onreject<span class="o">(</span>this.reason<span class="o">)</span>
                        resolvePromise<span class="o">(</span>p, x, resolve, reject<span class="o">)</span>
                    <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
                        reject<span class="o">(</span>e<span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">})</span>
                
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span>this.status <span class="o">===</span> PENDDING<span class="o">)</span> <span class="o">{</span>
                this.resolveCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                    setTimeout<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                        try<span class="o">{</span>
                            <span class="nb">let </span>x <span class="o">=</span> onfulfilled<span class="o">(</span>this.value<span class="o">)</span>
                            resolvePromise<span class="o">(</span>p, x, resolve, reject<span class="o">)</span>
                        <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
                            reject<span class="o">(</span>e<span class="o">)</span>
                        <span class="o">}</span>
                    <span class="o">})</span>
                <span class="o">})</span>
                this.rejectCallbacks.push<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                    setTimeout<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
                        try<span class="o">{</span>
                            <span class="nb">let </span>x <span class="o">=</span> onreject<span class="o">(</span>this.reason<span class="o">)</span>
                            resolvePromise<span class="o">(</span>p, x, resolve, reject<span class="o">)</span>
                        <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
                            reject<span class="o">(</span>e<span class="o">)</span>
                        <span class="o">}</span>
                    <span class="o">})</span>
                <span class="o">})</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="k">return </span>p
    <span class="o">}</span>

const resolvePromise <span class="o">=</span> <span class="o">(</span>p, x, resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    //判断x的类型
    <span class="k">if</span><span class="o">(</span>typeof x <span class="o">===</span> <span class="s2">"object"</span> <span class="o">&amp;&amp;</span> x <span class="o">!==</span> null <span class="o">||</span> typeof x <span class="o">===</span> <span class="s2">"function"</span><span class="o">){</span>
        try<span class="o">{</span>
            <span class="nb">let </span><span class="k">then</span> <span class="o">=</span> x.then
            <span class="k">if</span><span class="o">(</span>typeof <span class="k">then</span> <span class="o">===</span> <span class="s2">"function"</span><span class="o">){</span>
                //x是promise就采用promise执行的结果
                x.then<span class="o">(</span>y <span class="o">=&gt;</span> resolve<span class="o">(</span>y<span class="o">)</span>,r <span class="o">=&gt;</span> reject<span class="o">(</span>r<span class="o">))</span>
            <span class="o">}</span>
        <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
            reject<span class="o">(</span>e<span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        resolve<span class="o">(</span>x<span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
此时，如果then方法里面返回的promise是下面这样的该怎么解决：
<span class="nb">let </span>promise <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    resolve<span class="o">(</span><span class="s2">"ok1"</span><span class="o">)</span>
<span class="o">})</span>
<span class="nb">let </span>p1 <span class="o">=</span> promise.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success1:"</span> + data<span class="o">)</span>
    <span class="k">return </span>new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
        resolve<span class="o">(</span>new Promise<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
            resolve<span class="o">(</span><span class="s2">"ok2"</span><span class="o">)</span>
        <span class="o">}))</span>
    <span class="o">})</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error1: "</span>+err<span class="o">)</span>
<span class="o">})</span>
<span class="nb">let </span>p2 <span class="o">=</span> p1.then<span class="o">(</span>data <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"success2:"</span> + data<span class="o">)</span>
<span class="o">}</span>, err <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"error2: "</span>+err<span class="o">)</span>
<span class="o">})</span>
采用递归的方式一直执行resolvePromise方法
const resolvePromise <span class="o">=</span> <span class="o">(</span>p, x, resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    //判断x的类型
    <span class="k">if</span><span class="o">(</span>typeof x <span class="o">===</span> <span class="s2">"object"</span> <span class="o">&amp;&amp;</span> x <span class="o">!==</span> null <span class="o">||</span> typeof x <span class="o">===</span> <span class="s2">"function"</span><span class="o">){</span>
        try<span class="o">{</span>
            <span class="nb">let </span><span class="k">then</span> <span class="o">=</span> x.then
            <span class="k">if</span><span class="o">(</span>typeof <span class="k">then</span> <span class="o">===</span> <span class="s2">"function"</span><span class="o">){</span>
                //x是promise就采用promise执行的结果
                x.then<span class="o">(</span>y <span class="o">=&gt;</span> resolvePromise<span class="o">(</span>p, y, resolve, reject<span class="o">)</span>,r <span class="o">=&gt;</span> reject<span class="o">(</span>r<span class="o">))</span>
            <span class="o">}</span>
        <span class="o">}</span>catch<span class="o">(</span>e<span class="o">){</span>
            reject<span class="o">(</span>e<span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        resolve<span class="o">(</span>x<span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="如何中断一个promise链">如何中断一个promise链</h2><blockquote><p>就是返回一个等待的promsie</p></blockquote><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nb">let </span>p <span class="o">=</span> new Promise<span class="o">((</span>resolve, reject<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
    resolve<span class="o">()</span>
<span class="o">})</span>
p.then<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"1111"</span><span class="o">)</span>
    <span class="k">return </span>new Promise<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span> <span class="o">})</span>
<span class="o">})</span>.then<span class="o">(()</span> <span class="o">=&gt;</span> <span class="o">{</span>
    console.log<span class="o">(</span><span class="s2">"2222"</span><span class="o">)</span>
<span class="o">})</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/js/" class="post-tag no-text-decoration" >js</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=promise原理 - jyy&url=http://localhost:4000/posts/promise/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=promise原理 - jyy&u=http://localhost:4000/posts/promise/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=promise原理 - jyy&url=http://localhost:4000/posts/promise/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/webpack/">webpack</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/node/">node</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/promise-all/"><div class="card-body"> <span class="timeago small" > Jul 12, 2020 <i class="unloaded">2020-07-12T10:55:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>promise对象的几个方法分析</h3><div class="text-muted small"><p> promise.all 1 const p = Promise.all([p1, p2, p3]); 上面代码p的状态由p1、p2、p3决定，分成两种情况。 （1）只有p1、p2、p3的状态都变成fulfilled，p的状态才会变成fulfilled，此时p1、p2、p3的返回值组成一个数组，传递给p的回调函数。 （2）只要p1、p2、p3之中有一个被rejected，p的状态就变...</p></div></div></a></div><div class="card"> <a href="/posts/data-structure/"><div class="card-body"> <span class="timeago small" > Jul 20, 2020 <i class="unloaded">2020-07-20T15:20:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>数据结构</h3><div class="text-muted small"><p> 栈 特点：先进后出 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class Stack{ constructor(){ this.stack = [] } add(ele){ this.stack.push(ele) } pop(){ this.stack.p...</p></div></div></a></div><div class="card"> <a href="/posts/generator/"><div class="card-body"> <span class="timeago small" > Aug 2, 2020 <i class="unloaded">2020-08-02T14:20:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>generator</h3><div class="text-muted small"><p> iterator遍历器 es6上是这样定义的：它是一种接口，为各种不同的数据结构提供统一的访问机制。任何数据结构只要部署 Iterator 接口，就可以完成遍历操作 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 模拟一个遍历器生存函数 function makeIterator(arr){ let ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/leetcode/" class="btn btn-outline-primary"><p>leetcode解题</p></a> <a href="/posts/promise-all/" class="btn btn-outline-primary"><p>promise对象的几个方法分析</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/username">your_full_name</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/js/">js</a> <a class="post-tag" href="/tags/webpack/">webpack</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/node/">node</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
